var p=(h,d,r)=>new Promise((u,l)=>{var c=n=>{try{o(r.next(n))}catch(i){l(i)}},f=n=>{try{o(r.throw(n))}catch(i){l(i)}},o=n=>n.done?u(n.value):Promise.resolve(n.value).then(c,f);o((r=r.apply(h,d)).next())});import{u as M,r as t,j as a,h as g,C as P,e as k,f as b,X as D,d as j}from"./index-CEegmSMn.js";import{C as A,a as L,b as E,c as H}from"./CModalHeader-DgiXYpST.js";const I=()=>{const h=M(),[d,r]=t.useState([]),[u,l]=t.useState(!1),[c,f]=t.useState(!1),[o,n]=t.useState([]),[i,C]=t.useState(null),[y,S]=t.useState(!0),[_,x]=t.useState(!1);function v(){return p(this,null,function*(){const e=yield j.get("/api/method/parent_portal.parent_portal.api.get_fee_list",{headers:{"Content-Type":"application/json"}});n(e.data.message),S(!1)})}const F=t.useMemo(()=>[{name:"Student Name",selector:e=>a.jsx("div",{onClick:()=>{h(`/student-fee/${e.name}`)},children:e.student_name})},{name:"Date",selector:e=>e.posting_date,sortable:!0},{name:"Program",selector:e=>e.program},{name:"Family Code",selector:e=>e.family_code},{name:"Total",selector:e=>e.grand_total},{name:"Fee Status",selector:e=>a.jsx("div",{children:e.is_return==1?a.jsx("span",{className:"badge bg-secondary",children:"Refund"}):e.outstanding_amount==0?a.jsx("span",{className:"badge bg-success",children:"Paid"}):e.outstanding_amount>0&&g(e.due_date).isSameOrAfter(g(),"day")?a.jsx("span",{className:"badge bg-warning",children:"Unpaid"}):e.outstanding_amount>0&&g(e.due_date).isBefore(g(),"day")?a.jsx("span",{className:"badge bg-danger",children:"Overdue"}):a.jsx("span",{className:"badge bg-warning",children:"Draft"})})},{name:"Student Status",selector:e=>e.custom_status}],[o]),N=e=>{C(e.target.files[0])},R=t.useCallback(e=>{r(e.selectedRows)},[]),w=t.useMemo(()=>{const e=()=>p(void 0,null,function*(){x(!0);try{if(!i){alert("Please select a file to upload.");return}yield j.post("/api/method/parent_portal.parent_portal.api.make_portal_payment_record",{fees:d}).then(s=>p(void 0,null,function*(){const m=new FormData;m.append("file",i),m.append("is_private",0),m.append("doctype","Portal Payment Record"),m.append("docname",s.data.message.record_name),yield j.post("/api/method/upload_file",m,{headers:{"Content-Type":"multipart/form-data",Accept:"application/json"}})})).catch(s=>console.error(s)),C(null),x(!1),f(!c),l(!1)}catch(s){console.error("Error during file upload:",s),x(!1),alert("An error occurred. Please try again.")}});return a.jsxs("div",{className:"mt-3",children:[a.jsxs(P,{className:"row g-12",onSubmit:s=>{s.preventDefault(),l(!0)},children:[a.jsx("div",{className:"mb-3 col-6",children:a.jsx(k,{type:"file",id:"formFile",required:!0,onChange:N})}),a.jsx("div",{className:"mb-3 col-6 text-end",children:a.jsx(b,{color:"primary",type:"submit",children:"Submit"})})]}),a.jsxs(A,{visible:u,onClose:()=>l(!1),children:[a.jsx(L,{children:"Confirm Attachments"}),a.jsxs(E,{children:["Please confirm payment slip attachments for the following fees:",a.jsx("ul",{children:d.map(s=>a.jsx("li",{children:s.name},s.name))})]}),a.jsxs(H,{children:[a.jsx(b,{color:"secondary",onClick:()=>l(!1),children:"Cancel"}),a.jsx(b,{color:"danger",onClick:e,disabled:_,children:_?"attach...":"Confirm"})]})]})]})},[o,d,c,u]);return t.useEffect(()=>{v()},[]),a.jsx(a.Fragment,{children:a.jsx("div",{className:"body m-4 mt-0 p-2 bg-white pt-0 rounded",children:a.jsx(D,{title:"Fee List",columns:F,data:o.length>0?o:[],progressPending:y,pagination:!0,highlightOnHover:!0,pointerOnHover:!0,selectableRows:!0,contextActions:w,onSelectedRowsChange:R,clearSelectedRows:c,selectableRowDisabled:e=>e.parent_attachment===1})})})};export{I as default};
